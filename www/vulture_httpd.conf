ServerRoot {{ VulturePath }}
ServerName localhost

ServerTokens Prod
ServerSignature Off

Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 15

StartServers            5
MinSpareServers         5
MaxSpareServers         10
MaxClients              150
MaxRequestsPerChild     0

PidFile {{ VulturePath }}{{ VultureID }}.pid

user apache
group apache

LoadFile			/usr/lib/libxml2.so.2
LoadModule apreq_module		/usr/lib/apache2/modules/mod_apreq2.so
LoadModule perl_module		/usr/lib/apache2/modules/mod_perl.so
LoadModule ssl_module		/usr/lib/apache2/modules/mod_ssl.so
LoadModule proxy_module		/usr/lib/apache2/modules/mod_proxy.so
LoadModule proxy_http_module	/usr/lib/apache2/modules/mod_proxy_http.so
LoadModule proxy_ftp_module	/usr/lib/apache2/modules/mod_proxy_ftp.so
LoadModule proxy_connect_module	/usr/lib/apache2/modules/mod_proxy_connect.so
LoadModule setenvif_module	/usr/lib/apache2/modules/mod_setenvif.so
LoadModule authz_host_module	/usr/lib/apache2/modules/mod_authz_host.so
LoadModule unique_id_module	/usr/lib/apache2/modules/mod_unique_id.so

LoadModule security2_module     /opt/vulture/lib/mod_security2.so
LoadModule auth_kerb_module	/usr/lib/apache2/modules/mod_auth_kerb.so

PerlSwitches {{ PerlSwitches }}

BrowserMatch "Mozilla/2" nokeepalive
BrowserMatch "MSIE 4\.0b2;" nokeepalive downgrade-1.0 force-response-1.0
BrowserMatch "RealPlayer 4\.0" force-response-1.0
BrowserMatch "Java/1\.0" force-response-1.0
BrowserMatch "JDK/1\.0" force-response-1.0
BrowserMatch "Microsoft Data Access Internet Publishing Provider" redirect-carefully
BrowserMatch "^WebDrive" redirect-carefully
BrowserMatch "^gnome-vfs" redirect-carefully
BrowserMatch "^WebDAVFS" redirect-carefully

AddDefaultCharset off

PerlModule Apache2::Reload
PerlInitHandler Apache2::Reload

PerlSetVar ReloadAll			Off

PerlSetVar VultureDSNv3			dbi:SQLite:dbname={{ dbname }}
PerlSetVar VultureID			{{ VultureID }}
PerlSetVar VultureAppCookieName		vulture_app
PerlSetVar VultureProxyCookieName	vulture_proxy

Listen {{ ip }}:{{ port }}
NameVirtualHost {{ ip }}:{{ port }}

<IfModule mod_mime.c>
        TypesConfig {{ VulturePath }}mime.types
</IfModule>

LogLevel warn
ServerRoot /usr/lib/apache2

LogLevel {{ log.level|safe }}
ErrorLog {{ log.dir|safe }}/Vulture-{{ ip|safe }}-error_log
    
    {% if ssl %}
	SSLSessionCache dbm:{{ VulturePath }}{{ VultureID }}.sslcache
	SSLRandomSeed startup builtin
	SSLRandomSeed connect builtin
    {% endif %}


{% for app in app_list %}
<VirtualHost {{ ip|safe }}:{{ port|safe }}>
	ServerName {{ app.name|safe }}

    LogLevel {{ app.log.level|safe }}
    LogFormat {{ app.log.format|safe }} vultureFormat
    ErrorLog {{ app.log.dir|safe }}/Vulture-{{ app.name|safe }}-error_log
    CustomLog {{ app.log.dir|safe }}/Vulture-{{ app.name|safe }}-access_log vultureFormat

    SSLProxyEngine On

{% if remote_proxy %}
ProxyRemote * {{ remote_proxy }}
AllowCONNECT 443
{% endif %}

{% if remote_proxy_SSLProxyMachineCertificateFile %}
SSLProxyMachineCertificateFile {{ remote_proxy_SSLProxyMachineCertificateFile }}
{% endif %}
{% if remote_proxy_SSLProxyCACertificateFile %}
SSLProxyCACertificateFile {{ remote_proxy_SSLProxyCACertificateFile }}
{% endif %}
{% if remote_proxy_SSLProxyCARevocationFile %}
SSLProxyCARevocationFile  {{ remote_proxy_SSLProxyCARevocationFile }}
{% endif %}
{% if remote_proxy_SSLProxyVerify %}
SSLProxyVerify {{remote_proxy_SSLProxyVerify }}
{% endif %}

    SetHandler perl-script
    <Location />
        PerlAuthenHandler Core::AuthenHandler
        PerlAuthzHandler  Core::AuthzHandler
        AuthType basic
        AuthName "Please Authenticate"
        Require valid-user
    </Location>

        #PerlPreConnectionHandler Core::PreConnectionHandler
	PerlTransHandler Core::TransHandlerv2
	#PerlAccessHandler Core::AccessHandler
	PerlFixupHandler Core::FixupHandler
	PerlResponseHandler Core::ResponseHandlerv2

    ProxyRequests Off
    ProxyVia Off

    {% if ssl %}
        SSLEngine               On
        PerlModule              Apache::SSLLookup
	{% if ssl_engine %} 
		SSLCryptoDevice {{ ssl_engine }}
	{% endif %}
        SSLCertificateKeyFile   {{ VulturePath }}{{ VultureID }}.key
        SSLCertificateFile      {{ VulturePath }}{{ VultureID }}.crt
        SSLCertificateChainFile {{ VulturePath }}{{ VultureID }}.chain

        {% for auth in app.auth.all %}
		{% if auth.is_ssl %}
			SSLCACertificateFile {{ VulturePath }}{{ VultureID }}-{{ app.name }}.ca
		{% endif %}
	{% endfor %}
        SSLOptions              +StdEnvVars
    {% endif %}

    {% if app.security.all %}
        SecWebAppId {{ app.name }}
        SecAuditLog {{ app.log.dir|safe }}/Vulture-{{ app.name }}-security_log

	SecComponentSignature "core ruleset/2.2.1"

	SecRule REQUEST_HEADERS:User-Agent "^(.*)$" "phase:1,id:'981217',t:none,pass,nolog,t:sha1,t:hexEncode,setvar:tx.ua_hash=%{matched_var}"
	SecRule REQUEST_HEADERS:x-forwarded-for "^\b(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\b" "phase:1,id:'981225',t:none,pass,nolog,capture,setvar:tx.real_ip=%{tx.1}"
	SecRule &TX:REAL_IP "!@eq 0" "phase:1,id:'981226',t:none,pass,nolog,initcol:global=global,initcol:ip=%{tx.real_ip}_%{tx.ua_hash}"
	SecRule &TX:REAL_IP "@eq 0"  "phase:1,id:'981218',t:none,pass,nolog,initcol:global=global,initcol:ip=%{remote_addr}_%{tx.ua_hash}"

        {% for row in app.security.all %}
            {{ row.rules|safe }}
        {% endfor %}
    {% endif %}

    ProxyPass	 / {{ app.url }}
    ProxyPassReverse / {{ app.url }}
    {{ app.getCookieDomain }}

    <Proxy *>
        SetHandler perl-script

        {% for auth in app.auth.all %}
		{% if auth.is_ssl %}
			{{ auth.getAuth.constraint }}
		{% endif %}
	{% endfor %}
    </Proxy>

</VirtualHost>
{% endfor %}
